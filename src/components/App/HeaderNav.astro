---
import AppHeaderLogo from '@/components/App/HeaderLogo.astro';
import AppHeaderButton from '@/components/App/HeaderButton.astro';

interface Props {
  class?: string;
  hasLogo?: boolean;
  items: {
    text: string;
    href: string;
  }[];
}

const {
  class: className,
  hasLogo = false,
  items,
  ...rest
} = Astro.props as Props;
---

<script>
  import gsap from 'gsap';

  const navs = document.querySelectorAll(
    '[data-js=header-nav]',
  ) as NodeListOf<HTMLElement>;

  navs.forEach(nav => {
    const navList = nav.querySelector('[data-js-header-nav-list]');
    const navItems = nav.querySelectorAll('[data-js-header-nav-item]');
    const pill = nav.querySelector('[data-js-header-nav-pill]');

    let pillActive = false;
    const duration = 0.3;
    const ease = 'back.out(0.6)';

    const updatePill = (target: any) => {
      const { offsetWidth, offsetLeft } = target.firstElementChild;

      if (pillActive) {
        gsap.to(pill, {
          opacity: 1,
          width: offsetWidth,
          left: offsetLeft,
          duration,
          ease,
        });
      } else {
        gsap.set(pill, {
          width: offsetWidth,
          left: offsetLeft,
        });

        gsap.to(pill, {
          opacity: 1,
          duration,
          ease,
          onStart: () => {
            pillActive = true;
          },
        });
      }
    };

    const hidePill = () => {
      gsap.to(pill, {
        opacity: 0,
        duration,
        ease,
      });
    };

    navList?.addEventListener('mouseleave', () => (pillActive = false));

    navItems?.forEach(item => {
      item.addEventListener('mouseenter', e => updatePill(e.target));
      item.addEventListener('mouseleave', hidePill);
    });
  });
</script>

<nav
  class="flex gap-4 md:bg-offblack/10 md:backdrop-blur-20 md:rounded-16 md:border border-white/10 md:p-3 transition-[background-color,border-color] duration-150 ease-smooth"
  {...rest}
>
  {
    hasLogo && (
      <a class="hidden md:block" href="/">
        <AppHeaderLogo />
        <span class="sr-only">Home</span>
      </a>
    )
  }

  <div data-js="header-nav md:relative" class:list={['header-nav', className]}>
    <ul data-js-header-nav-list class="header-nav__list">
      {
        items?.map((item: any) => (
          <li
            data-js-header-nav-item
            class:list={['h-full', item.type === 'alt' ? 'mdMax:hidden' : '']}
          >
            {item.hasSubmenu ? (
              <button
                data-js-header-nav-item-button
                class="block h-inherit p-12 md:p-3"
                type="button"
              >
                <AppHeaderButton hasSubmenu={true}>{item.text}</AppHeaderButton>
              </button>

              <nav data-js-header-nav-item-submenu class="absolute top-0 left-0 size-full z-1 p-40 bg-navy-light">
                <button data-js-header-nav-item-submenu-back type="button">
                  ‚Üê Back
                </button>

                <ul>
                  <li>
                    <a href="/">Sub Item 1</a>
                  </li>
                  <li>
                    <a href="/">Sub Item 2</a>
                  </li>
                </ul>
              </nav>
            ) : (
              <a
                class:list={['block h-inherit p-12 md:p-3']}
                href={item.href}
              >
                <AppHeaderButton color={item.color}>
                  {item.text}
                </AppHeaderButton>
              </a>
            )}
          </li>
        ))
      }
    </ul>

    <span
      data-js-header-nav-pill
      class="header-nav__pill block bg-yellow rounded-[12px] h-full absolute top-0 left-0 -z-1 opacity-0 mdMax:hidden"
    >
    </span>
  </div>
</nav>

<style>
  .header-nav {
    display: flex;
    height: 100%;
  }

  .header-nav__list {
    display: flex;
    flex-direction: column;

    @media screen(md) {
      margin: -3px;
      flex-direction: row;
    }
  }
</style>
